<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Bootstrap CSS -->
    <link href="libs/bootstrap.min.css" rel="stylesheet" />

    <!-- Bootstrap JS -->
    <script src="libs/bootstrap.bundle.min.js"></script>

    <!-- QR Code Scanning Library -->
    <script src="libs/html5-qrcode.min.js" type="text/javascript"></script>

    <!-- Excel (XLSX) Export Library -->
    <script src="libs/xlsx.full.min.js"></script>
    <title>Acreditacion</title>
  </head>
  <body class="bg-light p-4">
    <div class="container">
      <h1 class="mb-4 text-center">Acreditación de Alumnos</h1>
      <!-- Info and Configuration Bar -->
      <div class="card mb-4">
        <div
          class="card-body d-flex justify-content-between align-items-center flex-wrap gap-2"
        >
          <div>
            <small class="text-muted d-block">Servidor:</small>
            <strong id="current-url"></strong>
          </div>
          <div>
            <small class="text-muted d-block">Ciudad Activa:</small>
            <strong id="current-ciudad"></strong>
          </div>
          <button
            class="btn btn-outline-secondary"
            data-bs-toggle="modal"
            data-bs-target="#configModal"
          >
            Configurar
          </button>
        </div>
      </div>
      <!-- Controls: Search, Filter, Buttons -->
      <div class="row mb-3">
        <div
          class="d-flex flex-wrap gap-2 align-items-end"
          style="padding: 0 12px"
        >
          <div class="flex-grow-1" style="min-width: 200px">
            <label for="searchInput" class="form-label mb-1"
              >Buscar por DNI o Nombre</label
            >
            <input type="text" id="searchInput" class="form-control" />
          </div>
          <div style="min-width: 200px">
            <label for="escuelaFilter" class="form-label mb-1"
              >Filtrar por Escuela</label
            >
            <select id="escuelaFilter" class="form-select escuela-select">
              <option value="">Todas las Escuelas</option>
            </select>
          </div>
          <div style="min-width: 200px">
            <label for="cursoFilter" class="form-label mb-1"
              >Filtrar por Curso</label
            >
            <select id="cursoFilter" class="form-select">
              <option value="">Todos los cursos</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
            </select>
          </div>
          <button id="clearFilterBtn" class="btn btn-secondary">Limpiar</button>
          <button
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#addAlumnoModal"
          >
            Nuevo Alumno
          </button>
          <button
            id="scanQrBtn"
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#qrScannerModal"
          >
            Scan QR
          </button>
          <button id="exportBtn" class="btn btn-success">
            Exportar a Excel
          </button>
        </div>
      </div>
      <div class="row mt-3">
        <div class="table-responsive">
          <table
            class="table table-striped table-hover align-middle shadow-sm rounded"
          >
            <caption id="table-caption" class="caption-top">
              Cargando registros...
            </caption>
            <thead class="">
              <tr id="alumnos-head">
                <th>Id</th>
                <th>Ciudad</th>
                <th>DNI</th>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Email</th>
                <th>Escuela</th>
                <th>Curso</th>
                <th>Rol</th>
                <th>Asistencia</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="alumnos-body"></tbody>
          </table>
        </div>
      </div>
      <!-- Pagination Container -->
      <div
        class="d-flex justify-content-end align-items-center mt-3"
        id="pagination-container"
      >
        <span id="page-info" class="me-3 text-secondary"></span>
        <nav id="pagination"></nav>
      </div>
    </div>

    <!-- Configuration Modal -->
    <div class="modal fade" id="configModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="configForm">
            <div class="modal-header">
              <h5 class="modal-title">Configuración</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="configUrlInput" class="form-label"
                  >URL del Servidor Supabase</label
                >
                <input
                  type="url"
                  id="configUrlInput"
                  class="form-control"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="configCiudadSelect" class="form-label"
                  >Ciudad de Trabajo</label
                >
                <select id="configCiudadSelect" class="form-select">
                  <option value="" disabled>Cargando ciudades...</option>
                </select>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cancelar
              </button>
              <button type="submit" class="btn btn-primary">
                Guardar y Recargar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal Nuevo Alumno-->
    <div
      class="modal fade"
      id="addAlumnoModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="alumnoForm">
            <div class="modal-header">
              <h5 class="modal-title">Agregar Alumno</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <!-- Example fields: adjust names to your alumnos schema -->
              <div class="mb-3">
                <label class="form-label">DNI</label>
                <input type="text" name="dni" class="form-control" required />
              </div>
              <div class="mb-3">
                <label class="form-label">Nombre</label>
                <input
                  type="text"
                  name="nombre"
                  class="form-control"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Apellido</label>
                <input
                  type="text"
                  name="apellido"
                  class="form-control"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input
                  type="email"
                  name="email"
                  class="form-control"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="addEscuelaSelect" class="form-label">Escuela</label>
                <select
                  id="addEscuelaSelect"
                  name="escuelaId"
                  class="form-select"
                  required
                >
                  <option value="" disabled selected>
                    Seleccione una escuela...
                  </option>
                </select>
              </div>
              <div class="mb-3">
                <label for="addCursoSelect" class="form-label">Curso</label>
                <select
                  id="addCursoSelect"
                  name="curso"
                  class="form-select"
                  required
                >
                  <option value="" disabled selected>
                    Seleccione un curso...
                  </option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                  <option value="7">7</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="addRolSelect" class="form-label">Rol</label>
                <select
                  id="addRolSelect"
                  name="rolId"
                  class="form-select"
                  required
                >
                  <option value="1">Participante</option>
                  <option value="2">Expositor</option>
                </select>
              </div>
              <!-- Add more fields depending on your table columns -->
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cancelar
              </button>
              <button type="submit" class="btn btn-primary">Guardar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Edit Alumno Modal -->
    <div
      class="modal fade"
      id="editAlumnoModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="editAlumnoForm">
            <div class="modal-header">
              <h5 class="modal-title">Editar Alumno</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body">
              <input type="hidden" name="id" />
              <div class="mb-3">
                <label class="form-label">DNI</label>
                <input type="text" name="dni" class="form-control" required />
              </div>
              <div class="mb-3">
                <label class="form-label">Nombre</label>
                <input
                  type="text"
                  name="nombre"
                  class="form-control"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Apellido</label>
                <input
                  type="text"
                  name="apellido"
                  class="form-control"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input
                  type="email"
                  name="email"
                  class="form-control"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="editCursoSelect" class="form-label">Curso</label>
                <select
                  id="editCursoSelect"
                  name="curso"
                  class="form-select"
                  required
                >
                  <option value="" disabled selected>
                    Seleccione un curso...
                  </option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                  <option value="7">7</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="editEscuelaSelect" class="form-label"
                  >Escuela</label
                >
                <select
                  id="editEscuelaSelect"
                  name="escuelaId"
                  class="form-select"
                  required
                >
                  <option value="" disabled>Seleccione una escuela...</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="editRolSelect" class="form-label">Rol</label>
                <select
                  id="editRolSelect"
                  name="rolId"
                  class="form-select"
                  required
                >
                  <option value="1">Participante</option>
                  <option value="2">Expositor</option>
                </select>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cancelar
              </button>
              <button type="submit" class="btn btn-success">Actualizar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- QR Scanner Modal -->
    <div
      class="modal fade"
      id="qrScannerModal"
      tabindex="-1"
      aria-labelledby="qrScannerModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="qrScannerModalLabel">Scan QR Code</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div id="qr-reader" style="width: 100%"></div>
            <div id="qr-reader-results"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Alumno Info Modal -->
    <div
      class="modal fade"
      id="alumnoInfoModal"
      tabindex="-1"
      aria-labelledby="alumnoInfoModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="alumnoInfoModalLabel">
              Información del Alumno
            </h5>
            <!-- <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button> -->
          </div>
          <div class="modal-body">
            <p><strong>Ciudad:</strong> <span id="info-ciudad"></span></p>
            <p><strong>DNI:</strong> <span id="info-dni"></span></p>
            <p><strong>Nombre:</strong> <span id="info-nombre"></span></p>
            <p><strong>Apellido:</strong> <span id="info-apellido"></span></p>
            <p><strong>Email:</strong> <span id="info-email"></span></p>
            <p><strong>Escuela:</strong> <span id="info-escuela"></span></p>
            <p><strong>Curso:</strong> <span id="info-curso"></span></p>
            <p><strong>Rol:</strong> <span id="info-rol"></span></p>
            <p>
              <strong>Asistencia:</strong> <span id="info-asistencia"></span>
            </p>
          </div>
          <div class="modal-footer">
            <!-- <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
              onclick="getAlumnos()"
            >
              Cerrar
            </button> -->
            <button type="button" id="info-aceptar-btn" class="btn btn-success">
              Aceptar
            </button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
<script src="./libs/supabase.umd.js"></script>
<script>
  const { createClient } = supabase;

  // Create a single supabase client for interacting with your database
  let supabaseClient, supabaseUrl, selectedCiudadId;
  let ciudades = [];
  const supabaseKey =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJhbm9uIiwKICAgICJpc3MiOiAic3VwYWJhc2UtZGVtbyIsCiAgICAiaWF0IjogMTY0MTc2OTIwMCwKICAgICJleHAiOiAxNzk5NTM1NjAwCn0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE";
  //console.log(supabase);

  const itemsPerPage = 10;
  let currentPage = 1;

  async function initializeApp() {
    // 1. Load settings from localStorage or use defaults
    supabaseUrl =
      localStorage.getItem("supabaseUrl") || "http://localhost:8000";
    selectedCiudadId = localStorage.getItem("selectedCiudadId") || "1"; // Default to city with ID 1

    // 2. Create the Supabase client
    try {
      supabaseClient = createClient(supabaseUrl, supabaseKey);
    } catch (e) {
      alert(
        "URL del servidor Supabase inválida. Por favor, corríjala en la configuración."
      );
      console.error(e);
      return;
    }

    // 3. Populate UI elements and fetch initial data
    await populateConfigCiudadSelect(); // Fetches all cities and updates cache
    updateInfoBar();
    await populateEscuelasSelects();
    await getAlumnos();
  }

  function updateInfoBar() {
    document.getElementById("current-url").textContent = supabaseUrl;
    const ciudad = ciudades.find((c) => c.id == selectedCiudadId);
    document.getElementById("current-ciudad").textContent = ciudad
      ? `${ciudad.nombre} (ID: ${ciudad.id})`
      : "No seleccionada";
  }

  async function populateConfigCiudadSelect() {
    const { data, error } = await supabaseClient
      .from("ciudad")
      .select("id, nombre")
      .order("nombre");
    if (error) {
      console.error("Error fetching ciudades:", error);
      alert(
        "No se pudieron cargar las ciudades desde el servidor. Verifique la URL y la conexión."
      );
      return;
    }
    ciudades = data; // Update cache
    const select = document.getElementById("configCiudadSelect");
    select.innerHTML =
      '<option value="" disabled>Seleccione una ciudad...</option>'; // Clear
    ciudades.forEach((c) => select.add(new Option(c.nombre, c.id)));
    // Set the current value
    select.value = selectedCiudadId;
  }

  async function populateEscuelasSelects() {
    let query = await supabaseClient
      .from("escuelas")
      .select("id, nombre")
      .eq("ciudadId", selectedCiudadId)
      .order("nombre", { ascending: true });

    const { data, error } = await query;
    if (error) {
      console.error("Error fetching escuelas:", error);
      return;
    }

    const addSelect = document.getElementById("addEscuelaSelect");
    const editSelect = document.getElementById("editEscuelaSelect");
    const escuelaFilter = document.getElementById("escuelaFilter");

    while (addSelect.options.length > 1) addSelect.remove(1);
    while (editSelect.options.length > 1) editSelect.remove(1);
    while (escuelaFilter.options.length > 1) escuelaFilter.remove(1);

    data.forEach((escuela) => {
      const option = document.createElement("option");
      option.value = escuela.id;
      option.textContent = escuela.nombre;
      addSelect.appendChild(option.cloneNode(true));
      editSelect.appendChild(option.cloneNode(true));
      escuelaFilter.appendChild(option.cloneNode(true));
    });
  }

  async function getAlumnos(
    searchTerm = "",
    page = 1,
    escuelaId = "",
    curso = ""
  ) {
    const from = (page - 1) * itemsPerPage;
    const to = from + itemsPerPage - 1;
    const tableCaption = document.getElementById("table-caption");

    let query = supabaseClient
      .from("alumnos")
      .select(
        "id,dni,nombre,apellido,email,curso,asistencia,escuela:escuelaId(nombre),rol:rolId(nombre),ciudad:ciudadId(nombre)",
        {
          count: "exact"
        }
      )
      .eq("ciudadId", selectedCiudadId)
      .order("id", { ascending: false })
      .range(from, to);

    //if (searchTerm) {
    //  if (isNaN(searchTerm)) {
    //    query = query.or(
    //      `nombre.ilike.%${searchTerm}%,apellido.ilike.%${searchTerm}%`
    //    );
    //  } else {
    // cambiar por contiene
    //    query = query.eq("dni", searchTerm);
    //  }
    //}

    if (searchTerm) {
      query = query.or(
        `nombre_completo.ilike.%${searchTerm}%,dni.ilike.%${searchTerm}%`
      );
    }

    // Apply school filter
    if (escuelaId) {
      query = query.eq("escuelaId", escuelaId);
    }

    if (curso) {
      query = query.eq("curso", curso);
    }

    const { data, error, count } = await query;

    if (error) {
      console.error("Error fetching alumnos:", error.message);
      return;
    }

    console.log("Alumnos:", data);

    const tableBody = document.querySelector("#alumnos-body");
    tableBody.innerHTML = "";

    if (data.length > 0) {
      data.forEach((alumno) => {
        const row = document.createElement("tr");

        // Manually create cells to handle the nested escuela object
        const idCell = document.createElement("td");
        idCell.textContent = alumno.id;
        row.appendChild(idCell);

        const ciudadCell = document.createElement("td");
        ciudadCell.textContent = alumno.ciudad ? alumno.ciudad.nombre : "";
        row.appendChild(ciudadCell);

        const dniCell = document.createElement("td");
        dniCell.textContent = alumno.dni;
        row.appendChild(dniCell);

        const nombreCell = document.createElement("td");
        nombreCell.textContent = alumno.nombre;
        row.appendChild(nombreCell);

        const apellidoCell = document.createElement("td");
        apellidoCell.textContent = alumno.apellido;
        row.appendChild(apellidoCell);

        const emailCell = document.createElement("td");
        emailCell.textContent = alumno.email;
        row.appendChild(emailCell);

        const escuelaCell = document.createElement("td");
        escuelaCell.textContent = alumno.escuela ? alumno.escuela.nombre : "";
        row.appendChild(escuelaCell);

        const cursoCell = document.createElement("td");
        cursoCell.textContent = alumno.curso;
        row.appendChild(cursoCell);

        const rolCell = document.createElement("td");
        rolCell.textContent = alumno.rol ? alumno.rol.nombre : "";
        row.appendChild(rolCell);

        const asistenciaCell = document.createElement("td");
        const badge = document.createElement("span");
        badge.classList.add("badge", "d-inline-block", "text-center");
        if (alumno.asistencia) {
          badge.textContent = "SI";
          badge.classList.add("bg-success");
        } else {
          badge.textContent = "NO";
          badge.classList.add("bg-danger");
        }
        badge.style.width = "50px";
        asistenciaCell.appendChild(badge);
        row.appendChild(asistenciaCell);

        const actions = document.createElement("td");
        actions.innerHTML = `
            <button class="btn btn-sm btn-warning me-2 edit-btn" data-id="${alumno.id}">
              Editar
            </button>
            <button class="btn btn-sm btn-success me-2 asistencia-btn" data-id="${alumno.id}">
              Asistencia
            </button>
          `;
        row.appendChild(actions);
        tableBody.appendChild(row);
      });
    } else {
      const row = document.createElement("tr");
      const cell = document.createElement("td");
      cell.colSpan = 11;
      cell.textContent = "No se encontraron alumnos.";
      cell.className = "text-center";
      row.appendChild(cell);
      tableBody.appendChild(row);
    }

    tableCaption.textContent = `Total de registros encontrados: ${count}`;

    renderPagination(count);

    document.querySelectorAll(".edit-btn").forEach((btn) => {
      btn.addEventListener("click", () => openEditModal(btn.dataset.id));
    });
    document.querySelectorAll(".asistencia-btn").forEach((btn) => {
      btn.addEventListener("click", () => darAsistencia(btn.dataset.id));
    });
  }

  //Render Pagination
  function renderPagination(totalItems) {
    const paginationNav = document.getElementById("pagination");
    const pageInfo = document.getElementById("page-info");
    const paginationContainer = document.getElementById("pagination");
    const totalPages = Math.ceil(totalItems / itemsPerPage);

    paginationNav.innerHTML = "";
    pageInfo.innerHTML = "";

    if (totalItems === 0) {
      paginationContainer.style.display = "none";
      return;
    }

    paginationContainer.style.display = "flex";
    pageInfo.innerText = `Pagina ${currentPage} de ${totalPages}`;

    if (totalPages > 1) {
      const ul = document.createElement("ul");
      ul.className = "pagination";

      // Previous button
      const prevLi = document.createElement("li");
      prevLi.className = `page-item ${currentPage === 1 ? "disabled" : ""}`;
      const prevLink = document.createElement("a");
      prevLink.className = "page-link";
      prevLink.href = "#";
      prevLink.innerText = "Anterior";
      prevLink.addEventListener("click", (e) => {
        e.preventDefault();
        if (currentPage > 1) {
          currentPage--;
          const term = document.getElementById("searchInput").value.trim();
          const escuelaId = document.getElementById("escuelaFilter").value;
          const curso = document.getElementById("cursoFilter").value;
          getAlumnos(term, currentPage, escuelaId, curso);
        }
      });
      prevLi.appendChild(prevLink);
      ul.appendChild(prevLi);

      // Next button
      const nextLi = document.createElement("li");
      nextLi.className = `page-item ${
        currentPage === totalPages ? "disabled" : ""
      }`;
      const nextLink = document.createElement("a");
      nextLink.className = "page-link";
      nextLink.href = "#";
      nextLink.innerText = "Siguiente";
      nextLink.addEventListener("click", (e) => {
        e.preventDefault();
        if (currentPage < totalPages) {
          currentPage++;
          const term = document.getElementById("searchInput").value.trim();
          const escuelaId = document.getElementById("escuelaFilter").value;
          const curso = document.getElementById("cursoFilter").value;
          getAlumnos(term, currentPage, escuelaId, curso);
        }
      });
      nextLi.appendChild(nextLink);
      ul.appendChild(nextLi);

      paginationContainer.appendChild(ul);
    }
  }

  // Insert New Alumno
  async function insertAlumno(e) {
    e.preventDefault();

    // collect form values
    const form = document.querySelector("#alumnoForm");
    const formData = new FormData(form);

    // build insert object dynamically
    const newAlumno = {};
    formData.forEach((value, key) => {
      newAlumno[key] = value;
    });
    newAlumno.ciudadId = selectedCiudadId;

    const { error } = await supabaseClient.from("alumnos").insert([newAlumno]);

    if (error) {
      alert("Error inserting alumno: " + error.message);
    } else {
      form.reset();
      const modal = bootstrap.Modal.getInstance(
        document.getElementById("addAlumnoModal")
      );
      modal.hide();
      currentPage = 1;
      await getAlumnos(); // refresh table
    }
  }

  // Open edit modal
  async function openEditModal(id) {
    const { data, error } = await supabaseClient
      .from("alumnos")
      .select("*")
      .eq("id", id)
      .single();

    if (error) {
      alert("Error loading alumno: " + error.message);
      return;
    }

    const editForm = document.querySelector("#editAlumnoForm");
    editForm.dataset.id = id;

    // Fill inputs
    Object.keys(data).forEach((key) => {
      if (editForm[key]) {
        editForm[key].value = data[key];
      }
    });

    new bootstrap.Modal(document.getElementById("editAlumnoModal")).show();
  }

  // Save edited alumno
  async function updateAlumno(e) {
    e.preventDefault();
    const form = document.querySelector("#editAlumnoForm");
    const formData = new FormData(form);

    const updatedAlumno = {};
    formData.forEach((value, key) => (updatedAlumno[key] = value));

    const { error } = await supabaseClient
      .from("alumnos")
      .update(updatedAlumno)
      .eq("id", form.dataset.id);

    if (error) {
      alert("Error updating alumno: " + error.message);
    } else {
      bootstrap.Modal.getInstance(
        document.getElementById("editAlumnoModal")
      ).hide();
      const term = document.getElementById("searchInput").value.trim();
      const escuelaId = document.getElementById("escuelaFilter").value;
      const curso = document.getElementById("cursoFilter").value;
      await getAlumnos(term, currentPage, escuelaId, curso);
    }
  }

  // Dar asistencia
  async function darAsistencia(id) {
    const { error } = await supabaseClient
      .from("alumnos")
      .update({ asistencia: "true" })
      .eq("id", id);
    if (error) {
      alert("Error updating alumno: " + error.message);
    } else {
      alert("Asistencia OK");
      const term = document.getElementById("searchInput").value.trim();
      const escuelaId = document.getElementById("escuelaFilter").value;
      const curso = document.getElementById("cursoFilter").value;
      await getAlumnos(term, currentPage, escuelaId, curso);
    }
  }

  // Export to Excel
  async function exportToExcel() {
    const exportBtn = document.getElementById("exportBtn");
    exportBtn.disabled = true;
    exportBtn.textContent = "Exportando...";

    //const searchTerm = document.getElementById("searchInput").value.trim();
    //const escuelaId = document.getElementById("escuelaFilter").value;

    // Fetch ALL filtered data, without pagination (.range)
    let query = supabaseClient
      .from("alumnos")
      .select(
        "id,dni,nombre,apellido,email,curso,asistencia,escuela:escuelaId(nombre),rol:rolId(nombre),ciudad:ciudadId(nombre)"
      )
      .order("id", { ascending: false });

    // if (searchTerm) {
    //   query = isNaN(searchTerm)
    //     ? query.or(
    //         `nombre.ilike.%${searchTerm}%,apellido.ilike.%${searchTerm}%`
    //       )
    //     : query.or(`dni.ilike.%${searchTerm}%`);
    // }
    // if (escuelaId) {
    //   query = query.eq("escuelaId", escuelaId);
    // }

    const { data, error } = await query;

    if (error) {
      alert("Error fetching data for export: " + error.message);
      exportBtn.disabled = false;
      exportBtn.textContent = "Exportar a Excel";
      return;
    }

    if (data.length === 0) {
      alert("No data to export for the current filters.");
      exportBtn.disabled = false;
      exportBtn.textContent = "Exportar a Excel";
      return;
    }

    // Format the data for the worksheet
    const formattedData = data.map((alumno) => ({
      ID: alumno.id,
      CIUDAD: alumno.ciudad ? alumno.ciudad.nombre : "N/A",
      DNI: alumno.dni,
      Nombre: alumno.nombre,
      Apellido: alumno.apellido,
      Email: alumno.email,
      Escuela: alumno.escuela ? alumno.escuela.nombre : "N/A",
      Curso: alumno.curso,
      Rol: alumno.rol ? alumno.rol.nombre : "N/A",
      Asistencia: alumno.asistencia ? "Sí" : "No"
    }));

    // Create worksheet and workbook
    const worksheet = XLSX.utils.json_to_sheet(formattedData);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Alumnos");

    // Trigger the download
    XLSX.writeFile(workbook, "Lista_de_Alumnos.xlsx");

    exportBtn.disabled = false;
    exportBtn.textContent = "Exportar a Excel";
  }

  // --- QR Code Scanner Logic ---
  const qrScannerModalEl = document.getElementById("qrScannerModal");
  const html5QrCode = new Html5Qrcode("qr-reader");

  const onScanSuccess = async (decodedText, decodedResult) => {
    // Stop scanning
    html5QrCode
      .stop()
      .then((ignore) => {
        // Hide the scanner modal
        bootstrap.Modal.getInstance(qrScannerModalEl).hide();

        // Fetch alumno data by DNI (decodedText)
        findAndShowAlumnoByDni(decodedText);
      })
      .catch((err) => {
        console.error("Failed to stop QR scanner:", err);
      });
  };

  const findAndShowAlumnoByDni = async (dni) => {
    //Buscar alumno por dni
    const { data, error } = await supabaseClient
      .from("alumnos")
      .select("id")
      .eq("dni", dni)
      .single();

    if (error || !data) {
      alert(`Alumno con DNI ${dni} no encontrado.`);
      console.error("Error fetching alumno by DNI:", error);
      return;
    }

    // actualizar asistencia a TRUE
    const { data: updatedData, error: findError } = await supabaseClient
      .from("alumnos")
      .update({ asistencia: true })
      .eq("id", data.id)
      .select(
        "*, escuela:escuelaId(nombre), rol:rolId(nombre), ciudad:ciudadId(nombre)"
      )
      .single();
    if (findError) {
      alert("Error updating alumno: " + findError.message);
    }

    // Populate and show the info modal
    document.getElementById("info-ciudad").textContent = updatedData.ciudad
      ? updatedData.ciudad.nombre
      : "N/A";
    document.getElementById("info-dni").textContent = updatedData.dni;
    document.getElementById("info-nombre").textContent = updatedData.nombre;
    document.getElementById("info-apellido").textContent = updatedData.apellido;
    document.getElementById("info-email").textContent = updatedData.email;
    document.getElementById("info-escuela").textContent = updatedData.escuela
      ? updatedData.escuela.nombre
      : "N/A";
    document.getElementById("info-curso").textContent = updatedData.curso;
    document.getElementById("info-rol").textContent = updatedData.rol
      ? updatedData.rol.nombre
      : "N/A";
    document.getElementById("info-asistencia").textContent =
      updatedData.asistencia ? "Sí" : "No";

    // const asistenciaBtn = document.getElementById("info-asistencia-btn");
    // asistenciaBtn.dataset.id = data.id; // Store ID for the button
    // asistenciaBtn.disabled = data.asistencia === true; // Disable if already attended

    const infoModal = new bootstrap.Modal(
      document.getElementById("alumnoInfoModal")
    );
    infoModal.show();
  };

  const onScanFailure = (error) => {
    // We can ignore this to avoid spamming the console.
    // The library continuously tries to scan.
  };

  document.addEventListener("DOMContentLoaded", async () => {
    initializeApp();

    // --- Configuration Modal Logic ---
    const configModalEl = document.getElementById("configModal");
    configModalEl.addEventListener("show.bs.modal", () => {
      // Populate with current settings when opened
      document.getElementById("configUrlInput").value = supabaseUrl;
      document.getElementById("configCiudadSelect").value = selectedCiudadId;
    });

    document.getElementById("configForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const newUrl = document.getElementById("configUrlInput").value;
      const newCiudadId = document.getElementById("configCiudadSelect").value;

      // Save settings to localStorage
      localStorage.setItem("supabaseUrl", newUrl);
      localStorage.setItem("selectedCiudadId", newCiudadId);

      // Hide modal and re-initialize the whole app
      bootstrap.Modal.getInstance(configModalEl).hide();
      initializeApp();
    });

    //await populateEscuelasSelects();
    //await getAlumnos();

    const searchInput = document.getElementById("searchInput");
    const escuelaFilter = document.getElementById("escuelaFilter");
    const cursoFilter = document.getElementById("cursoFilter");
    const clearFilterBtn = document.getElementById("clearFilterBtn");
    const exportBtn = document.getElementById("exportBtn");

    document
      .getElementById("alumnoForm")
      .addEventListener("submit", insertAlumno);
    document
      .getElementById("editAlumnoForm")
      .addEventListener("submit", updateAlumno);

    searchInput.addEventListener("input", () => {
      currentPage = 1;
      getAlumnos(
        searchInput.value.trim(),
        currentPage,
        escuelaFilter.value,
        cursoFilter.value
      );
    });

    escuelaFilter.addEventListener("change", () => {
      currentPage = 1;
      getAlumnos(
        searchInput.value.trim(),
        currentPage,
        escuelaFilter.value,
        cursoFilter.value
      );
    });

    cursoFilter.addEventListener("change", () => {
      currentPage = 1;
      getAlumnos(
        searchInput.value.trim(),
        currentPage,
        escuelaFilter.value,
        cursoFilter.value
      );
    });

    clearFilterBtn.addEventListener("click", () => {
      searchInput.value = "";
      escuelaFilter.value = "";
      cursoFilter.value = "";
      currentPage = 1;
      getAlumnos();
    });

    exportBtn.addEventListener("click", exportToExcel);

    // QR Scanner Modal Events
    qrScannerModalEl.addEventListener("shown.bs.modal", () => {
      html5QrCode.start(
        { facingMode: "environment" }, // Prefer back camera
        {
          fps: 10,
          qrbox: { width: 250, height: 250 }
        },
        onScanSuccess,
        onScanFailure
      );
    });

    qrScannerModalEl.addEventListener("hidden.bs.modal", () => {
      // Ensure the scanner is stopped when modal is closed
      if (html5QrCode.isScanning) {
        html5QrCode
          .stop()
          .catch((err) => console.log("QR Scanner already stopped."));
      }
    });

    // Alumno Info Modal Asistencia Button
    document
      .getElementById("info-aceptar-btn")
      .addEventListener("click", function () {
        bootstrap.Modal.getInstance(
          document.getElementById("alumnoInfoModal")
        ).hide();
        getAlumnos();
      });
  });
</script>
